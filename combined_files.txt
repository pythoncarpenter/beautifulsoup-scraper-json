Files used in this run: Dockerfile run.sh scrape.log scrape.py

# Use a lightweight Python image
FROM python:3.12-slim

# Install pipenv so that run.sh can use it
RUN pip install pipenv

# Set the working directory in the container
WORKDIR /app

# Install Tkinter (python3-tk) and clean up to keep the image lean
RUN apt-get update && apt-get install -y python3-tk && rm -rf /var/lib/apt/lists/*

# Copy Pipfile and Pipfile.lock into the container
COPY Pipfile Pipfile.lock ./

# Install dependencies using pipenv
RUN pipenv install --deploy --ignore-pipfile

# Copy the rest of your application code into the container
COPY . .

# Set the default command to run the scraper script
CMD ["./run.sh"]
#!/bin/bash
# run.sh - Comprehensive one-click setup with recursive retry, network timeout handling,
# and graceful error handling for first-time execution.

# --- Enable Strict Error Handling ---
set -euo pipefail
trap 'echo "Error occurred at line ${LINENO}. Exiting." && exit 1' ERR

# --- Function: Retry pipenv install with network timeout handling ---
retry_pipenv_install() {
    local retries=3
    local count=1
    while [ $count -le $retries ]; do
        echo "Attempt $count of $retries: Running 'pipenv install'..."
        if pipenv install; then
            echo "pipenv install succeeded."
            return 0
        else
            echo "Attempt $count failed. Possible network issue. Retrying in 5 seconds..."
            sleep 5
        fi
        count=$((count + 1))
    done
    echo "pipenv install failed after $retries attempts."
    return 1
}

# --- Function: Check and wait for XQuartz on macOS (recursive) ---
check_xquartz_recursive() {
    if pgrep -x "XQuartz" > /dev/null; then
        echo "XQuartz is running."
    else
        echo "XQuartz not running. Retrying in 2 seconds..."
        sleep 2
        check_xquartz_recursive  # Recursive call until XQuartz is detected.
    fi
}

# --- Function: Setup environment and run scraper (recursive retry) ---
setup_and_run() {
    local attempt="${1:-1}"
    local max_attempts=5

    echo "Setup attempt $attempt of $max_attempts..."

    # Step 0: Ensure key files have execute permissions.
    chmod +x run.sh scrape.py setup_env.sh || echo "Warning: Could not update permissions for some files."

    # Step 1: Check for pipenv.
    if ! command -v pipenv >/dev/null 2>&1; then
        echo "Error: pipenv is not installed. Please install pipenv and try again." >&2
        exit 1
    fi

    # Step 2: Verify that Pipfile exists.
    if [ ! -f "Pipfile" ]; then
        echo "Error: Pipfile not found in the repository. Aborting." >&2
        exit 1
    fi

    # Step 3: Ensure the virtual environment exists; if not, create it.
    venv_path=$(pipenv --venv 2>/dev/null || true)
    if [ -z "$venv_path" ] || [ ! -d "$venv_path" ]; then
        echo "Virtual environment not found. Running 'pipenv install'..."
        if ! retry_pipenv_install; then
            echo "Error: 'pipenv install' failed. Aborting."
            exit 1
        fi
        # After installing, recursively call setup_and_run to re-check the environment.
        if [ "$attempt" -lt "$max_attempts" ]; then
            sleep 2
            setup_and_run $((attempt + 1))
            return
        else
            echo "Max attempts reached while creating virtual environment. Aborting."
            exit 1
        fi
    fi

    # Step 4: Check that the Python version is correct (3.12 expected).
    expected_python="3.12"
    venv_python_version=$(pipenv run python -c "import sys; print('.'.join(map(str, sys.version_info[:2])))" 2>/dev/null)
    if [ "$venv_python_version" != "$expected_python" ]; then
        echo "Error: Python version in virtual environment ($venv_python_version) does not match expected ($expected_python)." >&2
        exit 1
    fi

    # Step 5: Verify required packages are installed.
    required_packages=("pandas" "numpy" "statsmodels" "matplotlib" "openai")
    pipenv run pip list > /tmp/installed_packages.txt
    for pkg in "${required_packages[@]}"; do
        if ! grep -qi "$pkg" /tmp/installed_packages.txt; then
            echo "Error: Package '$pkg' is not installed in the virtual environment." >&2
            rm /tmp/installed_packages.txt
            exit 1
        fi
    done
    rm /tmp/installed_packages.txt
    echo "Environment checks passed."

    # Step 6: Setup system-specific GUI engine.
    os_type=$(uname)
    if [[ "$os_type" == "Darwin" ]]; then
        # On macOS, ensure XQuartz is running.
        if ! pgrep -x "XQuartz" > /dev/null; then
            echo "XQuartz is not running. Launching XQuartz..."
            open -a XQuartz || { echo "Error: Failed to launch XQuartz. Aborting."; exit 1; }
        fi
        # Use recursive function to wait for XQuartz.
        check_xquartz_recursive
        # Set DISPLAY if not already set.
        if [ -z "${DISPLAY:-}" ]; then
            echo "DISPLAY variable not set. Setting to :0.0 for GUI support."
            export DISPLAY=:0.0
        fi
    elif [[ "$os_type" == "Linux" ]]; then
        if [ -z "${DISPLAY:-}" ]; then
            echo "Warning: DISPLAY is not set. Ensure an X server is running for GUI support." >&2
        fi
    elif [[ "$os_type" == MINGW* || "$os_type" == CYGWIN* ]]; then
        echo "Windows detected. Please ensure you have a compatible GUI engine available." >&2
    fi

    # Step 7: Run the scraper application.
    echo "Starting the scraper application..."
    if [ -z "${VIRTUAL_ENV:-}" ]; then
        pipenv run python scrape.py || { echo "Error: Running scrape.py failed."; exit 1; }
    else
        python scrape.py || { echo "Error: Running scrape.py failed."; exit 1; }
    fi

    echo "Scraper application completed successfully."
    echo "Check scrape.log and the output JSON file for results."
}

# --- Kick Off the Setup Process ---
setup_and_run 1
2025-02-01 17:26:35 INFO: Submit button pressed.
2025-02-01 17:26:35 INFO: Mode selected: fixes
2025-02-01 17:26:35 INFO: Starting scrape_fix_pages for URL: https://github.com/vercel/nft/pull/455
2025-02-01 17:26:35 DEBUG: Starting new HTTPS connection (1): github.com:443
2025-02-01 17:26:36 DEBUG: https://github.com:443 "GET /vercel/nft/pull/455 HTTP/1.1" 200 None
2025-02-01 17:26:36 INFO: Received response with status code: 200
2025-02-01 17:26:36 DEBUG: HTML snippet for fix page: 






<!DOCTYPE html>
<html
  lang="en"
  
  data-color-mode="auto" data-light-theme="light" data-dark-theme="dark"
  data-a11y-animated-images="system" data-a11y-link-underlines="true"
  
  >



  <head>
    <meta charset="utf-8">
  <link rel="dns-prefetch" href="https://github.githubassets.com">
...
2025-02-01 17:26:36 INFO: Found 0 fix rows
2025-02-01 17:26:36 INFO: Finished scraping fixes. Total fixes: 0
2025-02-01 17:26:36 INFO: Results successfully written to /Users/mitchmcquoid/Desktop/fixes444.json
2025-02-01 17:35:16 INFO: Submit button pressed.
2025-02-01 17:35:16 INFO: Mode selected: fixes
2025-02-01 17:35:16 INFO: Starting scrape_fix_pages for URL: https://github.com/vercel/nft/pull/455
2025-02-01 17:35:16 DEBUG: Starting new HTTPS connection (1): github.com:443
2025-02-01 17:35:17 DEBUG: https://github.com:443 "GET /vercel/nft/pull/455 HTTP/1.1" 200 None
2025-02-01 17:35:17 INFO: Received response with status code: 200
2025-02-01 17:35:17 INFO: Found 16 conversation items
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 DEBUG: Skipping an item due to missing content.
2025-02-01 17:35:17 INFO: Finished scraping fixes. Total responses: 8
2025-02-01 17:35:17 INFO: Results successfully written to /Users/mitchmcquoid/Desktop/fix2222.json
2025-02-01 18:01:32 INFO: Submit button pressed.
2025-02-01 18:01:32 INFO: Mode selected: fixes
2025-02-01 18:01:32 INFO: Starting scrape_fix_pages for URL: https://github.com/vercel/nft/issues
2025-02-01 18:01:32 DEBUG: Starting new HTTPS connection (1): github.com:443
2025-02-01 18:01:33 DEBUG: https://github.com:443 "GET /vercel/nft/issues HTTP/1.1" 200 None
2025-02-01 18:01:33 INFO: Received response with status code: 200
2025-02-01 18:01:33 INFO: Found 0 conversation items
2025-02-01 18:01:33 INFO: Finished scraping fixes. Total responses: 0
2025-02-01 18:01:33 INFO: Results successfully written to /Users/mitchmcquoid/Desktop/fixes.json
2025-02-01 18:01:56 INFO: Submit button pressed.
2025-02-01 18:01:56 INFO: Mode selected: fixes
2025-02-01 18:01:56 INFO: Starting scrape_fix_pages for URL: https://github.com/vercel/nft/pull/455
2025-02-01 18:01:56 DEBUG: Starting new HTTPS connection (1): github.com:443
2025-02-01 18:01:57 DEBUG: https://github.com:443 "GET /vercel/nft/pull/455 HTTP/1.1" 200 None
2025-02-01 18:01:57 INFO: Received response with status code: 200
2025-02-01 18:01:57 INFO: Found 16 conversation items
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:01:57 INFO: Finished scraping fixes. Total responses: 8
2025-02-01 18:01:57 INFO: Results successfully written to /Users/mitchmcquoid/Desktop/fixes999.json
2025-02-01 18:05:36 INFO: Submit button pressed.
2025-02-01 18:05:36 INFO: Mode selected: fixes
2025-02-01 18:05:36 INFO: Starting scrape_fix_pages for URL: https://github.com/vercel/nft/pull/455
2025-02-01 18:05:36 DEBUG: Starting new HTTPS connection (1): github.com:443
2025-02-01 18:05:37 DEBUG: https://github.com:443 "GET /vercel/nft/pull/455 HTTP/1.1" 200 None
2025-02-01 18:05:37 INFO: Received response with status code: 200
2025-02-01 18:05:37 INFO: Found 16 conversation items
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:05:37 INFO: Duplicate item skipped: {'id': 'e8644d62-3114-479b-a35e-1d4d048271a8', 'type': 'comment', 'author': 'benmccann', 'timestamp': '2024-12-09T22:48:48Z', 'content': 'This removes 5 dependencies from the dependency tree'}
2025-02-01 18:05:37 INFO: Duplicate item skipped: {'id': '768bae17-0954-406b-9cd3-5e019dcb98f6', 'type': 'comment', 'author': 'benmccann', 'timestamp': '2024-12-09T22:48:48Z', 'content': 'This removes 5 dependencies from the dependency tree'}
2025-02-01 18:05:37 INFO: Duplicate item skipped: {'id': '559694fe-1185-4ea6-ba67-52af1cc8253b', 'type': 'comment', 'author': 'socket-security', 'timestamp': '2024-12-09T22:56:28Z', 'content': 'New and removed dependencies detected.Learn more aboutSocket for GitHub â†—ï¸ŽPackageNew capabilitiesTransitivesSizePublishernpm/@types/picomatch@3.0.1None018.1 kBtypesðŸš® Removed packages:npm/@types/micromatch@4.0.6View full reportâ†—ï¸Ž'}
2025-02-01 18:05:37 INFO: Duplicate item skipped: {'id': '292da71c-ea21-481f-9d93-2338f60cc473', 'type': 'comment', 'author': 'socket-security', 'timestamp': '2024-12-09T22:56:28Z', 'content': 'New and removed dependencies detected.Learn more aboutSocket for GitHub â†—ï¸ŽPackageNew capabilitiesTransitivesSizePublishernpm/@types/picomatch@3.0.1None018.1 kBtypesðŸš® Removed packages:npm/@types/micromatch@4.0.6View full reportâ†—ï¸Ž'}
2025-02-01 18:05:37 INFO: Finished scraping fixes. Total unique responses: 4
2025-02-01 18:05:37 INFO: Results successfully written to /Users/mitchmcquoid/Desktop/fixes.json
2025-02-01 18:09:54 INFO: Submit button pressed.
2025-02-01 18:09:54 INFO: Mode selected: fixes
2025-02-01 18:09:54 INFO: Starting scrape_fix_pages for URL: https://github.com/vercel/nft/pull/455
2025-02-01 18:09:54 DEBUG: Starting new HTTPS connection (1): github.com:443
2025-02-01 18:09:54 DEBUG: https://github.com:443 "GET /vercel/nft/pull/455 HTTP/1.1" 200 None
2025-02-01 18:09:55 INFO: Received response with status code: 200
2025-02-01 18:09:55 INFO: Found 16 conversation items
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 DEBUG: Skipping a fix item due to missing content.
2025-02-01 18:09:55 INFO: Duplicate item skipped: {'id': 'ebfb88b5-3bf2-4362-89d5-3f5841c5c9c5', 'type': 'comment', 'author': 'benmccann', 'timestamp': '2024-12-09T22:48:48Z', 'content': 'This removes 5 dependencies from the dependency tree'}
2025-02-01 18:09:55 INFO: Duplicate item skipped: {'id': '55472a6d-cb5e-43b0-af86-1618b78f93a2', 'type': 'comment', 'author': 'benmccann', 'timestamp': '2024-12-09T22:48:48Z', 'content': 'This removes 5 dependencies from the dependency tree'}
2025-02-01 18:09:55 INFO: Duplicate item skipped: {'id': 'ccbffa3c-0b26-4c3a-aea7-af7e5244e059', 'type': 'comment', 'author': 'socket-security', 'timestamp': '2024-12-09T22:56:28Z', 'content': 'New and removed dependencies detected.Learn more aboutSocket for GitHub â†—ï¸ŽPackageNew capabilitiesTransitivesSizePublishernpm/@types/picomatch@3.0.1None018.1 kBtypesðŸš® Removed packages:npm/@types/micromatch@4.0.6View full reportâ†—ï¸Ž'}
2025-02-01 18:09:55 INFO: Duplicate item skipped: {'id': 'b90abd5b-f152-43ed-807d-ec0f30613fe5', 'type': 'comment', 'author': 'socket-security', 'timestamp': '2024-12-09T22:56:28Z', 'content': 'New and removed dependencies detected.Learn more aboutSocket for GitHub â†—ï¸ŽPackageNew capabilitiesTransitivesSizePublishernpm/@types/picomatch@3.0.1None018.1 kBtypesðŸš® Removed packages:npm/@types/micromatch@4.0.6View full reportâ†—ï¸Ž'}
2025-02-01 18:09:55 INFO: Finished scraping fixes. Total unique responses: 4
2025-02-01 18:09:55 INFO: Results successfully written to /Users/mitchmcquoid/Desktop/fixes.json

